# MCPé”™è¯¯é˜²ç«å¢™ç³»ç»Ÿ - åŠŸèƒ½è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: v1.0.0  
**æ—¥æœŸ**: 2025-11-20  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
**ç›®æ ‡**: å®ç°"åŒä¸€é”™è¯¯åªçŠ¯ä¸€æ¬¡"çš„æ™ºèƒ½é”™è¯¯é˜²æŠ¤ç³»ç»Ÿ  

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒç†å¿µ](#æ ¸å¿ƒç†å¿µ)
3. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
4. [ç°æœ‰åŸºç¡€è®¾æ–½åˆ†æ](#ç°æœ‰åŸºç¡€è®¾æ–½åˆ†æ)
5. [è¯¦ç»†è®¾è®¡](#è¯¦ç»†è®¾è®¡)
6. [å®ç°è·¯çº¿å›¾](#å®ç°è·¯çº¿å›¾)
7. [åº”ç”¨åœºæ™¯](#åº”ç”¨åœºæ™¯)
8. [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)

---

## ç³»ç»Ÿæ¦‚è¿°

### 1.1 èƒŒæ™¯ä¸ç›®æ ‡

åœ¨AIè¾…åŠ©ç¼–ç¨‹è¿‡ç¨‹ä¸­ï¼ŒAIå¯èƒ½ä¼šé‡å¤çŠ¯åŒæ ·çš„é”™è¯¯ï¼ˆå¦‚ä½¿ç”¨ä¸å­˜åœ¨çš„iOSè™šæ‹Ÿè®¾å¤‡ã€å¼•ç”¨å·²åˆ é™¤çš„APIã€é…ç½®é”™è¯¯çš„ä¾èµ–ç‰ˆæœ¬ç­‰ï¼‰ã€‚**é”™è¯¯é˜²ç«å¢™ç³»ç»Ÿ**æ—¨åœ¨é€šè¿‡MCPåè®®å»ºç«‹ä¸€ä¸ªæ™ºèƒ½çš„é”™è¯¯æ‹¦æˆªä¸å­¦ä¹ æœºåˆ¶ï¼Œç¡®ä¿ï¼š

> **"åŒä¸€é”™è¯¯åªçŠ¯ä¸€æ¬¡"** - ä¸€æ—¦é”™è¯¯è¢«è®°å½•ï¼Œç³»ç»Ÿå°†æ°¸ä¹…æ‹¦æˆªç›¸åŒæ¨¡å¼çš„æ“ä½œ

### 1.2 ç³»ç»Ÿå®šä½

æœ¬ç³»ç»Ÿæ˜¯MCP Enterprise Server v2.0.0çš„**æ ¸å¿ƒæ‰©å±•æ¨¡å—**ï¼Œä¸ç°æœ‰çš„37ä¸ªMCPå·¥å…·ã€ä¸‰çº§è®°å¿†ç³»ç»Ÿã€å‘é‡æ£€ç´¢ç³»ç»Ÿæ·±åº¦é›†æˆï¼Œå½¢æˆï¼š

```
AIç¼–ç¨‹åŠ©æ‰‹ â†’ MCPé”™è¯¯é˜²ç«å¢™ â†’ å®é™…æ“ä½œæ‰§è¡Œ
              â†“ (æ‹¦æˆª)
         é”™è¯¯çŸ¥è¯†åº“ + è§£å†³æ–¹æ¡ˆåº“
```

### 1.3 æ ¸å¿ƒä»·å€¼

| ä»·å€¼ç»´åº¦ | ä¼ ç»Ÿæ–¹å¼ | é”™è¯¯é˜²ç«å¢™ç³»ç»Ÿ |
|---------|---------|---------------|
| é”™è¯¯é‡å¤ç‡ | 30-50% | <1% |
| é”™è¯¯ä¿®å¤æ—¶é—´ | 5-30åˆ†é’Ÿ | <10ç§’ï¼ˆè‡ªåŠ¨è¿”å›è§£å†³æ–¹æ¡ˆï¼‰ |
| å¼€å‘æ•ˆç‡ | åŸºçº¿ | â†‘40-60% |
| çŸ¥è¯†æ²‰æ·€ | ä¾èµ–æ–‡æ¡£ | è‡ªåŠ¨åŒ–çŸ¥è¯†åº“ |

---

## æ ¸å¿ƒç†å¿µ

### 2.1 å››å±‚é˜²æŠ¤æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: åé¦ˆæ›´æ–°å±‚ (Feedback Loop)                     â”‚
â”‚  - è‡ªåŠ¨æ•è·æ–°é”™è¯¯ â†’ æå–ç‰¹å¾ â†’ å†™å…¥çŸ¥è¯†åº“                  â”‚
â”‚  - è§£å†³æ–¹æ¡ˆéªŒè¯ â†’ æ•ˆæœè¯„ä¼° â†’ çŸ¥è¯†åº“ä¼˜åŒ–                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: æ‹¦æˆªä¸­é—´ä»¶å±‚ (Interception Middleware)         â”‚
â”‚  - å‰ç½®æ‹¦æˆªï¼šæ“ä½œæ‰§è¡Œå‰å¼ºåˆ¶æ ¡éªŒ                            â”‚
â”‚  - é£é™©è¯„ä¼°ï¼šåŸºäºå†å²é”™è¯¯è®¡ç®—æ“ä½œé£é™©åº¦                     â”‚
â”‚  - æ™ºèƒ½æ”¾è¡Œï¼šä½é£é™©æ“ä½œå¿«é€Ÿé€šè¿‡ï¼Œé«˜é£é™©å¼ºåˆ¶æ ¡éªŒ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: æ ¡éªŒå·¥å…·å±‚ (Validation Tools)                  â”‚
â”‚  - ç¯å¢ƒæ ¡éªŒå·¥å…·ï¼šéªŒè¯æ“ä½œä¾èµ–çš„ç¯å¢ƒèµ„æºæ˜¯å¦å­˜åœ¨              â”‚
â”‚  - é”™è¯¯åŒ¹é…å¼•æ“ï¼šå¤šç»´åº¦ç‰¹å¾åŒ¹é…å†å²é”™è¯¯                     â”‚
â”‚  - è§£å†³æ–¹æ¡ˆæ£€ç´¢ï¼šåŸºäºå‘é‡æ£€ç´¢è¿”å›æœ€ä½³è§£å†³æ–¹æ¡ˆ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: é”™è¯¯çŸ¥è¯†åº“ (Error Knowledge Base)              â”‚
â”‚  - ç»“æ„åŒ–å­˜å‚¨ï¼šMySQLå­˜å‚¨é”™è¯¯å…ƒæ•°æ®                        â”‚
â”‚  - å‘é‡ç´¢å¼•ï¼šMilvuså­˜å‚¨é”™è¯¯ç‰¹å¾å‘é‡ï¼ˆè¯­ä¹‰æ£€ç´¢ï¼‰            â”‚
â”‚  - å¿«é€Ÿç¼“å­˜ï¼šRedisç¼“å­˜é«˜é¢‘é”™è¯¯ï¼ˆ<5mså“åº”ï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒå·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIå‘èµ·æ“ä½œ â”‚ (å¦‚: ç¼–è¯‘iOSé¡¹ç›®ï¼Œé€‰æ‹©è®¾å¤‡ iPhone 15 17.0)
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‹¦æˆªä¸­é—´ä»¶ï¼šæå–æ“ä½œç‰¹å¾                  â”‚
â”‚ - operation_type: "ios_build"           â”‚
â”‚ - device_name: "iPhone 15"              â”‚
â”‚ - os_version: "17.0"                    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”™è¯¯åŒ¹é…å¼•æ“ï¼šå¤šç»´åº¦åŒ¹é…                  â”‚
â”‚ 1. å¿«é€Ÿç¼“å­˜æŸ¥è¯¢ (Redis)                  â”‚
â”‚ 2. ç»“æ„åŒ–åŒ¹é… (MySQL)                    â”‚
â”‚ 3. è¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é… (Milvuså‘é‡æ£€ç´¢)        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€â”€â”€â”€ å‘½ä¸­é”™è¯¯ â”€â”€â”€â”€â”
      â”‚                  â–¼
      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚         â”‚ è¿”å›æ‹¦æˆªç»“æœï¼š          â”‚
      â”‚         â”‚ - status: "blocked"    â”‚
      â”‚         â”‚ - error_id: "xxx"      â”‚
      â”‚         â”‚ - solution: "..."      â”‚
      â”‚         â”‚ - avoid_rule: "..."    â”‚
      â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â””â”€â”€â”€â”€ æœªå‘½ä¸­ â”€â”€â”€â”€â”
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ç¯å¢ƒæ ¡éªŒå·¥å…·ï¼š          â”‚
              â”‚ - æŸ¥è¯¢çœŸå®å¯ç”¨è®¾å¤‡åˆ—è¡¨   â”‚
              â”‚ - éªŒè¯è®¾å¤‡æ˜¯å¦å­˜åœ¨       â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”œâ”€ éªŒè¯å¤±è´¥ï¼ˆæ–°é”™è¯¯ï¼‰ â”€â”
                   â”‚                      â–¼
                   â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚             â”‚ é”™è¯¯æ•è· â†’ ç‰¹å¾æå– â”‚
                   â”‚             â”‚ â†’ è‡ªåŠ¨å…¥åº“ â†’ è¿”å›æç¤ºâ”‚
                   â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â””â”€ éªŒè¯é€šè¿‡ â”€â”
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ æ”¾è¡Œæ“ä½œ â†’ æ‰§è¡Œç¼–è¯‘ â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç°æœ‰åŸºç¡€è®¾æ–½åˆ†æ

### 3.1 å½“å‰MCP Enterprise Server v2.0.0æ ¸å¿ƒèƒ½åŠ›

åŸºäºå¯¹ç°æœ‰ä»£ç çš„åˆ†æï¼Œå½“å‰ç³»ç»Ÿå·²å…·å¤‡ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼Œå¯ç›´æ¥ç”¨äºé”™è¯¯é˜²ç«å¢™ç³»ç»Ÿï¼š

#### 3.1.1 ä¸‰çº§è®°å¿†ç³»ç»Ÿ âœ…

**ä½ç½®**: `src/mcp_core/services/memory_service.py`

| è®°å¿†å±‚çº§ | å­˜å‚¨æ–¹å¼ | é€‚ç”¨åœºæ™¯ | é”™è¯¯é˜²ç«å¢™åº”ç”¨ |
|---------|---------|---------|--------------|
| çŸ­æœŸè®°å¿† (Short) | Redis (TTL 1å°æ—¶) | ä¼šè¯å†…ä¸´æ—¶æ•°æ® | **é«˜é¢‘é”™è¯¯ç¼“å­˜**ï¼ˆ5åˆ†é’Ÿå†…é‡å¤æ“ä½œç›´æ¥æ‹¦æˆªï¼‰ |
| ä¸­æœŸè®°å¿† (Mid) | Milvuså‘é‡åº“ | é¡¹ç›®çº§çŸ¥è¯† | **é”™è¯¯ç‰¹å¾å‘é‡å­˜å‚¨**ï¼ˆè¯­ä¹‰ç›¸ä¼¼é”™è¯¯åŒ¹é…ï¼‰ |
| é•¿æœŸè®°å¿† (Long) | MySQLæ•°æ®åº“ | æ ¸å¿ƒäº‹å® | **ç»“æ„åŒ–é”™è¯¯çŸ¥è¯†åº“**ï¼ˆæ°¸ä¹…å­˜å‚¨é”™è¯¯å…ƒæ•°æ®ï¼‰ |

**ç°æœ‰èƒ½åŠ›**:
- `store_memory()`: å­˜å‚¨è®°å¿†åˆ°æŒ‡å®šå±‚çº§
- `retrieve_memory()`: æ£€ç´¢ç›¸å…³è®°å¿†ï¼ˆæ”¯æŒå‘é‡ç›¸ä¼¼åº¦æ£€ç´¢ï¼‰
- `_extract_core_info()`: æå–æ ¸å¿ƒä¿¡æ¯ï¼ˆå¯ç”¨äºé”™è¯¯ç‰¹å¾æå–ï¼‰
- `_calculate_relevance_score()`: è®¡ç®—ç›¸å…³æ€§è¯„åˆ†ï¼ˆå¯ç”¨äºé”™è¯¯åŒ¹é…ç½®ä¿¡åº¦ï¼‰

**ç›´æ¥å¤ç”¨**:
```python
# é”™è¯¯å­˜å‚¨ç¤ºä¾‹ï¼ˆåˆ©ç”¨ç°æœ‰è®°å¿†ç³»ç»Ÿï¼‰
memory_service.store_memory(
    project_id="error_firewall",
    content=error_description,
    memory_level="long",  # æ°¸ä¹…å­˜å‚¨
    metadata={
        "error_id": "ios_compile_no_device_iphone15_17.0",
        "error_type": "environment_validation",
        "solution": "ä½¿ç”¨xcrun simctl listæŸ¥è¯¢å¯ç”¨è®¾å¤‡",
        "avoid_rule": "ç¼–è¯‘å‰å¿…é¡»éªŒè¯è®¾å¤‡å­˜åœ¨æ€§"
    }
)
```

#### 3.1.2 å‘é‡æ£€ç´¢ç³»ç»Ÿ âœ…

**ä½ç½®**: `src/mcp_core/services/vector_db.py`

**ç°æœ‰èƒ½åŠ›**:
- **Collectionç®¡ç†**: æ”¯æŒåˆ›å»º/åˆ é™¤Collection
- **å‘é‡æ“ä½œ**: æ’å…¥ã€æœç´¢ã€åˆ é™¤å‘é‡ï¼ˆåŸºäºMilvusï¼‰
- **ç›¸ä¼¼åº¦æ£€ç´¢**: `search_vectors()` - æ”¯æŒä½™å¼¦ç›¸ä¼¼åº¦æ£€ç´¢
- **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡æ’å…¥ï¼ˆbatch_sizeå¯é…ç½®ï¼‰

**Schemaè®¾è®¡**ï¼ˆå·²æœ‰ä¸­æœŸè®°å¿†Collectionï¼‰:
```python
COLLECTION_SCHEMAS = {
    "mid_term_memories": {
        "fields": [
            {"name": "memory_id", "dtype": DataType.VARCHAR, "max_length": 64},
            {"name": "project_id", "dtype": DataType.VARCHAR, "max_length": 64},
            {"name": "embedding", "dtype": DataType.FLOAT_VECTOR, "dim": 768},
            {"name": "content", "dtype": DataType.VARCHAR, "max_length": 2000},
            {"name": "category", "dtype": DataType.VARCHAR, "max_length": 50},
            ...
        ]
    }
}
```

**é”™è¯¯é˜²ç«å¢™åº”ç”¨**:
- æ–°å»ºCollection: `error_vectors`ï¼ˆå­˜å‚¨é”™è¯¯ç‰¹å¾å‘é‡ï¼‰
- é”™è¯¯åŒ¹é…: å°†AIæ“ä½œè½¬æ¢ä¸ºå‘é‡ â†’ `search_vectors()` â†’ è¿”å›ç›¸ä¼¼å†å²é”™è¯¯

#### 3.1.3 Redisç¼“å­˜ç³»ç»Ÿ âœ…

**ä½ç½®**: `src/mcp_core/services/redis_client.py`

**ç°æœ‰èƒ½åŠ›**:
- **çŸ­æœŸè®°å¿†**: `store_short_memory()` / `retrieve_short_memory()`
- **ç¼“å­˜æ“ä½œ**: `cache_set()` / `cache_get()` / `cache_delete()`
- **ç»Ÿè®¡åŠŸèƒ½**: `accumulate_token_usage()` / `get_token_stats()`

**é”™è¯¯é˜²ç«å¢™åº”ç”¨**:
- **é«˜é¢‘é”™è¯¯ç¼“å­˜**: 5åˆ†é’Ÿå†…é‡å¤æ“ä½œç›´æ¥ä»Redisè¿”å›æ‹¦æˆªç»“æœï¼ˆ<5msï¼‰
- **å®æ—¶ç»Ÿè®¡**: è®°å½•é”™è¯¯æ‹¦æˆªæ¬¡æ•°ã€æ‹¦æˆªæˆåŠŸç‡

#### 3.1.4 æ•°æ®åº“æ¨¡å‹ âœ…

**ä½ç½®**: `src/mcp_core/models/tables.py`

**ç°æœ‰è¡¨ç»“æ„**:
- `Project`: é¡¹ç›®ç®¡ç†
- `LongMemory`: é•¿æœŸè®°å¿†å­˜å‚¨ï¼ˆå¯ç›´æ¥å­˜å‚¨é”™è¯¯çŸ¥è¯†ï¼‰
- `AuditLog`: å®¡è®¡æ—¥å¿—ï¼ˆå¯è®°å½•é”™è¯¯æ‹¦æˆªæ“ä½œï¼‰

**å¯ç›´æ¥æ‰©å±•**:
- æ–°å¢ `ErrorKnowledge` è¡¨ï¼ˆä¸“é—¨å­˜å‚¨é”™è¯¯çŸ¥è¯†ï¼‰
- æ–°å¢ `ErrorInterception` è¡¨ï¼ˆè®°å½•æ‹¦æˆªå†å²ï¼‰

#### 3.1.5 åµŒå…¥æœåŠ¡ âœ…

**ä½ç½®**: `src/mcp_core/services/embedding_service.py`

**ç°æœ‰èƒ½åŠ›**:
- æ–‡æœ¬è½¬å‘é‡ï¼š`get_embedding(text)` â†’ 768ç»´å‘é‡
- æ‰¹é‡è½¬æ¢ï¼š`get_batch_embeddings(texts)`

**é”™è¯¯é˜²ç«å¢™åº”ç”¨**:
- é”™è¯¯æè¿°è½¬å‘é‡ â†’ å­˜å…¥Milvus
- AIæ“ä½œæè¿°è½¬å‘é‡ â†’ è¯­ä¹‰åŒ¹é…å†å²é”™è¯¯

#### 3.1.6 ä¸­æ–‡åˆ†è¯æ”¯æŒ âœ…

**ä½ç½®**: `src/mcp_core/services/memory_service.py` (å·²é›†æˆjieba)

**ç°æœ‰èƒ½åŠ›**:
- ä¸­æ–‡å…³é”®è¯æå–ï¼š`_extract_keywords_jieba()`
- æ··åˆä¸­è‹±æ–‡å¤„ç†

**é”™è¯¯é˜²ç«å¢™åº”ç”¨**:
- é”™è¯¯æè¿°å…³é”®è¯æå–ï¼ˆå¦‚"è™šæ‹Ÿè®¾å¤‡""ä¸å­˜åœ¨""ç¼–è¯‘å¤±è´¥"ï¼‰
- æé«˜ä¸­æ–‡é”™è¯¯åŒ¹é…å‡†ç¡®ç‡

### 3.2 ç°æœ‰ç³»ç»Ÿæ¶æ„ä¼˜åŠ¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCP Enterprise Server v2.0.0 (å·²æœ‰åŸºç¡€è®¾æ–½)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å­˜å‚¨å±‚:                                                     â”‚
â”‚  âœ… MySQL (ç»“æ„åŒ–æ•°æ®) + Redis (ç¼“å­˜) + Milvus (å‘é‡æ£€ç´¢)     â”‚
â”‚                                                              â”‚
â”‚  æœåŠ¡å±‚:                                                     â”‚
â”‚  âœ… MemoryService (ä¸‰çº§è®°å¿†) + EmbeddingService (å‘é‡åŒ–)     â”‚
â”‚  âœ… RedisClient (ç¼“å­˜ç®¡ç†) + VectorDBClient (å‘é‡æ£€ç´¢)       â”‚
â”‚                                                              â”‚
â”‚  å·¥å…·å±‚:                                                     â”‚
â”‚  âœ… 37ä¸ªMCPå·¥å…· (å¯æ‰©å±•é”™è¯¯æ ¡éªŒå·¥å…·)                         â”‚
â”‚                                                              â”‚
â”‚  ç‰¹æ€§:                                                       â”‚
â”‚  âœ… ä¸­æ–‡æ”¯æŒ (jiebaåˆ†è¯) + æ—¥å¿—å®¡è®¡ (AuditLog)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
              ã€åªéœ€æ–°å¢é”™è¯¯é˜²ç«å¢™æ¨¡å—ã€‘
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–°å¢: ErrorFirewallService (é”™è¯¯é˜²ç«å¢™æœåŠ¡)                 â”‚
â”‚  - å¤ç”¨MemoryServiceå­˜å‚¨é”™è¯¯çŸ¥è¯†                             â”‚
â”‚  - å¤ç”¨VectorDBè¿›è¡Œè¯­ä¹‰åŒ¹é…                                  â”‚
â”‚  - å¤ç”¨Redisç¼“å­˜é«˜é¢‘é”™è¯¯                                     â”‚
â”‚  - æ–°å¢æ‹¦æˆªä¸­é—´ä»¶ + ç¯å¢ƒæ ¡éªŒå·¥å…·                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ä¼˜åŠ¿**:
1. **æ— éœ€é‡æ„å­˜å‚¨å±‚**: ç›´æ¥å¤ç”¨MySQL + Redis + Milvus
2. **æ— éœ€é‡æ–°å¼€å‘å‘é‡æ£€ç´¢**: MemoryServiceå·²å®ç°è¯­ä¹‰æ£€ç´¢
3. **æ— éœ€é‡æ–°å®ç°ç¼“å­˜**: RedisClientå·²æä¾›é«˜æ€§èƒ½ç¼“å­˜
4. **å¼€å‘æˆæœ¬é™ä½70%**: åªéœ€æ–°å¢ä¸šåŠ¡é€»è¾‘å±‚

---

## è¯¦ç»†è®¾è®¡

### 4.1 æ•°æ®æ¨¡å‹è®¾è®¡

#### 4.1.1 é”™è¯¯çŸ¥è¯†è¡¨ (ErrorKnowledge)

**è¡¨å**: `error_knowledge`  
**å­˜å‚¨å¼•æ“**: MySQL (InnoDB)  
**å­—ç¬¦é›†**: utf8mb4

```python
class ErrorKnowledge(Base):
    """é”™è¯¯çŸ¥è¯†åº“è¡¨"""
    
    __tablename__ = "error_knowledge"
    __table_args__ = (
        Index("idx_error_scene_type", "error_scene", "error_type"),
        Index("idx_error_created", "created_at"),
        UniqueConstraint("error_id", name="uq_error_id"),
        {"mysql_charset": "utf8mb4", "mysql_collate": "utf8mb4_unicode_ci"},
    )
    
    # ä¸»é”®
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    error_id = Column(String(128), unique=True, nullable=False, index=True,
                     comment="é”™è¯¯å”¯ä¸€æ ‡è¯†: {operation}_{error_type}_{key_params}")
    
    # é”™è¯¯åœºæ™¯
    error_scene = Column(String(100), nullable=False, index=True,
                        comment="é”™è¯¯åœºæ™¯: ios_build/api_call/dependency_install")
    error_type = Column(String(50), nullable=False, index=True,
                       comment="é”™è¯¯ç±»å‹: environment/syntax/logic/network")
    
    # é”™è¯¯ç‰¹å¾ (ç”¨äºç²¾å‡†åŒ¹é…)
    error_features = Column(JSON, nullable=False,
                           comment="é”™è¯¯ç‰¹å¾: {device_name, os_version, api_name, ...}")
    error_description = Column(Text, nullable=False,
                              comment="é”™è¯¯æè¿° (ç”¨äºå‘é‡åŒ–)")
    
    # åŒ¹é…ç­–ç•¥
    match_strategy = Column(String(20), default="hybrid",
                           comment="åŒ¹é…ç­–ç•¥: exact/fuzzy/semantic/hybrid")
    match_threshold = Column(Float, default=0.85,
                            comment="åŒ¹é…é˜ˆå€¼ (0-1)")
    
    # è§£å†³æ–¹æ¡ˆ
    solution = Column(Text, nullable=False,
                     comment="è¯¦ç»†è§£å†³æ–¹æ¡ˆ (å¯ç›´æ¥æ‰§è¡Œ)")
    solution_type = Column(String(20), default="manual",
                          comment="è§£å†³æ–¹æ¡ˆç±»å‹: auto/manual/interactive")
    solution_commands = Column(JSON, nullable=True,
                              comment="è‡ªåŠ¨åŒ–å‘½ä»¤åºåˆ— (å¦‚æœsolution_type=auto)")
    
    # è§„é¿è§„åˆ™
    avoid_rule = Column(Text, nullable=False,
                       comment="è§„é¿è§„åˆ™ (AIå¿…é¡»éµå®ˆ)")
    validation_tool = Column(String(100), nullable=True,
                            comment="ç¯å¢ƒæ ¡éªŒå·¥å…·åç§°")
    
    # ç»Ÿè®¡ä¿¡æ¯
    hit_count = Column(Integer, default=0,
                      comment="æ‹¦æˆªæ¬¡æ•°")
    last_hit_at = Column(DateTime, nullable=True,
                        comment="æœ€åæ‹¦æˆªæ—¶é—´")
    effectiveness_score = Column(Float, default=1.0,
                                comment="æœ‰æ•ˆæ€§è¯„åˆ† (0-1)")
    
    # å…ƒæ•°æ®
    error_log_sample = Column(Text, nullable=True,
                             comment="é”™è¯¯æ—¥å¿—æ ·æœ¬")
    related_errors = Column(JSON, nullable=True,
                           comment="ç›¸å…³é”™è¯¯IDåˆ—è¡¨")
    tags = Column(JSON, nullable=True,
                 comment="æ ‡ç­¾: ['ios', 'xcode', 'simulator']")
    
    # å®¡è®¡
    created_by = Column(String(64), default="system",
                       comment="åˆ›å»ºè€…: system/user_id")
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    is_active = Column(Boolean, default=True,
                      comment="æ˜¯å¦æ¿€æ´» (å¤±æ•ˆé”™è¯¯è®¾ä¸ºFalse)")
    
    def __repr__(self) -> str:
        return f"<ErrorKnowledge(id={self.error_id}, scene={self.error_scene})>"
```

**ç¤ºä¾‹æ•°æ®**:

```json
{
  "error_id": "ios_build_no_device_iphone15_17.0",
  "error_scene": "ios_build",
  "error_type": "environment",
  "error_features": {
    "device_name": "iPhone 15",
    "os_version": "17.0",
    "error_pattern": "No such device",
    "build_tool": "xcodebuild"
  },
  "error_description": "iOSé¡¹ç›®ç¼–è¯‘æ—¶é€‰æ‹©äº†ä¸å­˜åœ¨çš„è™šæ‹Ÿè®¾å¤‡ iPhone 15 (iOS 17.0)",
  "match_strategy": "hybrid",
  "match_threshold": 0.9,
  "solution": "1. æ‰§è¡Œ `xcrun simctl list devices available` è·å–æ‰€æœ‰å¯ç”¨è™šæ‹Ÿè®¾å¤‡\n2. ä»åˆ—è¡¨ä¸­é€‰æ‹©å­˜åœ¨çš„è®¾å¤‡ (å¦‚ iPhone 15 Pro, iOS 17.2)\n3. åœ¨Xcodeä¸­ç¡®è®¤è®¾å¤‡å·²åˆ›å»º: Xcode â†’ Window â†’ Devices and Simulators\n4. å¦‚éœ€åˆ›å»ºæ–°è®¾å¤‡: `xcrun simctl create 'iPhone 15' com.apple.CoreSimulator.SimDeviceType.iPhone-15 com.apple.CoreSimulator.SimRuntime.iOS-17-0`",
  "solution_type": "interactive",
  "solution_commands": [
    "xcrun simctl list devices available"
  ],
  "avoid_rule": "ç¼–è¯‘iOSé¡¹ç›®å‰ï¼Œå¿…é¡»å…ˆè°ƒç”¨ `ios_simulator_query` å·¥å…·éªŒè¯ç›®æ ‡è®¾å¤‡æ˜¯å¦å­˜åœ¨",
  "validation_tool": "ios_simulator_query",
  "hit_count": 0,
  "effectiveness_score": 1.0,
  "error_log_sample": "xcodebuild: error: Unable to find a destination matching the provided destination specifier:\n\t\t{ platform:iOS Simulator, OS:17.0, name:iPhone 15 }\n\nAvailable destinations for the \"MyApp\" scheme:\n\t\t{ platform:iOS Simulator, id:xxxxx, OS:17.2, name:iPhone 15 Pro }",
  "tags": ["ios", "xcode", "simulator", "environment"],
  "created_by": "system"
}
```

#### 4.1.2 é”™è¯¯æ‹¦æˆªè®°å½•è¡¨ (ErrorInterception)

**è¡¨å**: `error_interceptions`  
**ç”¨é€”**: è®°å½•æ¯æ¬¡é”™è¯¯æ‹¦æˆªçš„è¯¦ç»†ä¿¡æ¯ï¼ˆå®¡è®¡ + ç»Ÿè®¡åˆ†æï¼‰

```python
class ErrorInterception(Base):
    """é”™è¯¯æ‹¦æˆªè®°å½•è¡¨"""
    
    __tablename__ = "error_interceptions"
    __table_args__ = (
        Index("idx_interception_error_time", "error_id", "created_at"),
        Index("idx_interception_user", "user_id", "created_at"),
        Index("idx_interception_project", "project_id", "created_at"),
        {"mysql_charset": "utf8mb4", "mysql_collate": "utf8mb4_unicode_ci"},
    )
    
    # ä¸»é”®
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    interception_id = Column(String(64), unique=True, nullable=False,
                            comment="æ‹¦æˆªè®°å½•ID")
    
    # å…³è”ä¿¡æ¯
    error_id = Column(String(128), nullable=False, index=True,
                     comment="å‘½ä¸­çš„é”™è¯¯ID")
    user_id = Column(String(64), nullable=True, index=True,
                    comment="è§¦å‘ç”¨æˆ·ID")
    project_id = Column(String(64), nullable=True, index=True,
                       comment="é¡¹ç›®ID")
    
    # æ“ä½œä¿¡æ¯
    operation_type = Column(String(50), nullable=False,
                           comment="æ“ä½œç±»å‹: ios_build/api_call/...")
    operation_params = Column(JSON, nullable=False,
                             comment="æ“ä½œå‚æ•° (ç”¨äºåŒ¹é…)")
    
    # åŒ¹é…ç»“æœ
    match_method = Column(String(20), nullable=False,
                         comment="åŒ¹é…æ–¹å¼: cache/exact/semantic")
    match_score = Column(Float, nullable=True,
                        comment="åŒ¹é…å¾—åˆ† (0-1)")
    match_time_ms = Column(Integer, nullable=True,
                          comment="åŒ¹é…è€—æ—¶ (æ¯«ç§’)")
    
    # æ‹¦æˆªç»“æœ
    is_blocked = Column(Boolean, default=True,
                       comment="æ˜¯å¦æ‹¦æˆª")
    block_reason = Column(Text, nullable=True,
                         comment="æ‹¦æˆªåŸå› ")
    solution_provided = Column(Text, nullable=True,
                              comment="æä¾›çš„è§£å†³æ–¹æ¡ˆ")
    
    # ç”¨æˆ·åé¦ˆ
    user_feedback = Column(String(20), nullable=True,
                          comment="ç”¨æˆ·åé¦ˆ: helpful/not_helpful/ignored")
    feedback_comment = Column(Text, nullable=True,
                             comment="åé¦ˆå¤‡æ³¨")
    
    # å®¡è®¡
    created_at = Column(DateTime, server_default=func.now(), index=True)
    ip_address = Column(String(45), nullable=True)
    
    def __repr__(self) -> str:
        return f"<ErrorInterception(id={self.interception_id}, error={self.error_id})>"
```

#### 4.1.3 å‘é‡Collectionè®¾è®¡

**Collectionåç§°**: `error_vectors`  
**å­˜å‚¨å¼•æ“**: Milvus  
**ç”¨é€”**: å­˜å‚¨é”™è¯¯æè¿°çš„å‘é‡è¡¨ç¤ºï¼Œæ”¯æŒè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢

```python
ERROR_VECTOR_SCHEMA = {
    "error_vectors": {
        "description": "é”™è¯¯ç‰¹å¾å‘é‡åº“ (è¯­ä¹‰æ£€ç´¢)",
        "fields": [
            {
                "name": "error_id",
                "dtype": DataType.VARCHAR,
                "max_length": 128,
                "is_primary": True,
                "description": "é”™è¯¯ID (å…³è”error_knowledgeè¡¨)"
            },
            {
                "name": "embedding",
                "dtype": DataType.FLOAT_VECTOR,
                "dim": 768,
                "description": "é”™è¯¯æè¿°å‘é‡ (åŸºäºerror_descriptionç”Ÿæˆ)"
            },
            {
                "name": "error_scene",
                "dtype": DataType.VARCHAR,
                "max_length": 100,
                "description": "é”™è¯¯åœºæ™¯ (ç”¨äºè¿‡æ»¤)"
            },
            {
                "name": "error_type",
                "dtype": DataType.VARCHAR,
                "max_length": 50,
                "description": "é”™è¯¯ç±»å‹ (ç”¨äºè¿‡æ»¤)"
            },
            {
                "name": "created_at",
                "dtype": DataType.INT64,
                "description": "åˆ›å»ºæ—¶é—´æˆ³"
            }
        ],
        "index": {
            "field_name": "embedding",
            "index_type": "HNSW",
            "metric_type": "COSINE",
            "params": {"M": 16, "efConstruction": 200}
        }
    }
}
```

**æ£€ç´¢ç­–ç•¥**:
- **ç²¾å‡†åŒ¹é…**: `error_scene == 'ios_build' AND error_type == 'environment'` + å‘é‡ç›¸ä¼¼åº¦ > 0.9
- **æ¨¡ç³ŠåŒ¹é…**: ä»…åŸºäºå‘é‡ç›¸ä¼¼åº¦ > 0.85
- **æ··åˆç­–ç•¥**: ç»“æ„åŒ–è¿‡æ»¤ + å‘é‡æ£€ç´¢ + Redisç¼“å­˜

### 4.2 æ ¸å¿ƒæœåŠ¡è®¾è®¡

#### 4.2.1 ErrorFirewallService (é”™è¯¯é˜²ç«å¢™æœåŠ¡)

**ä½ç½®**: `src/mcp_core/services/error_firewall_service.py`

```python
"""
é”™è¯¯é˜²ç«å¢™æœåŠ¡
å®ç°é”™è¯¯æ‹¦æˆªã€åŒ¹é…ã€è®°å½•çš„æ ¸å¿ƒé€»è¾‘
"""

from typing import Dict, List, Optional, Tuple
from sqlalchemy.orm import Session
import time

from ..models.tables import ErrorKnowledge, ErrorInterception
from .memory_service import MemoryService
from .redis_client import get_redis_client
from .vector_db import get_vector_db_client
from .embedding_service import get_embedding_service
from ..common.logger import get_context_logger
from ..common.utils import generate_id

logger = get_context_logger(__name__)


class ErrorFirewallService:
    """é”™è¯¯é˜²ç«å¢™æœåŠ¡"""
    
    def __init__(self, db_session: Session):
        self.db = db_session
        self.memory_service = MemoryService(db_session)
        self.redis_client = get_redis_client()
        self.vector_db = get_vector_db_client()
        self.embedding_service = get_embedding_service()
        
        # ç¼“å­˜é…ç½®
        self.CACHE_TTL = 300  # 5åˆ†é’Ÿ
        self.CACHE_PREFIX = "error_firewall:"
        
    # ==================== æ ¸å¿ƒæ–¹æ³• ====================
    
    def validate_operation(
        self,
        operation_type: str,
        operation_params: Dict,
        user_id: Optional[str] = None,
        project_id: Optional[str] = None
    ) -> Dict:
        """
        éªŒè¯æ“ä½œæ˜¯å¦å®‰å…¨ (æ ¸å¿ƒæ‹¦æˆªæ–¹æ³•)
        
        Args:
            operation_type: æ“ä½œç±»å‹ (ios_build, api_call, ...)
            operation_params: æ“ä½œå‚æ•° (device_name, os_version, ...)
            user_id: ç”¨æˆ·ID
            project_id: é¡¹ç›®ID
            
        Returns:
            {
                "is_safe": bool,           # æ˜¯å¦å®‰å…¨
                "is_blocked": bool,        # æ˜¯å¦è¢«æ‹¦æˆª
                "error_id": str,           # å‘½ä¸­çš„é”™è¯¯ID (å¦‚æœis_blocked=True)
                "solution": str,           # è§£å†³æ–¹æ¡ˆ
                "avoid_rule": str,         # è§„é¿è§„åˆ™
                "match_method": str,       # åŒ¹é…æ–¹å¼ (cache/exact/semantic)
                "match_score": float,      # åŒ¹é…å¾—åˆ†
                "validation_time_ms": int  # éªŒè¯è€—æ—¶
            }
        """
        start_time = time.time()
        
        # æ­¥éª¤1: å¿«é€Ÿç¼“å­˜æŸ¥è¯¢ (5msä»¥å†…)
        cache_result = self._check_cache(operation_type, operation_params)
        if cache_result:
            logger.info(f"ç¼“å­˜å‘½ä¸­é”™è¯¯: {cache_result['error_id']}")
            result = {
                **cache_result,
                "match_method": "cache",
                "validation_time_ms": int((time.time() - start_time) * 1000)
            }
            self._record_interception(operation_type, operation_params, result, user_id, project_id)
            return result
        
        # æ­¥éª¤2: ç²¾å‡†åŒ¹é… (MySQLæŸ¥è¯¢)
        exact_match = self._exact_match(operation_type, operation_params)
        if exact_match:
            logger.info(f"ç²¾å‡†åŒ¹é…å‘½ä¸­é”™è¯¯: {exact_match['error_id']}")
            self._update_cache(operation_type, operation_params, exact_match)
            result = {
                **exact_match,
                "match_method": "exact",
                "validation_time_ms": int((time.time() - start_time) * 1000)
            }
            self._record_interception(operation_type, operation_params, result, user_id, project_id)
            return result
        
        # æ­¥éª¤3: è¯­ä¹‰åŒ¹é… (å‘é‡æ£€ç´¢)
        semantic_match = self._semantic_match(operation_type, operation_params)
        if semantic_match:
            logger.info(f"è¯­ä¹‰åŒ¹é…å‘½ä¸­é”™è¯¯: {semantic_match['error_id']} (score: {semantic_match['match_score']})")
            self._update_cache(operation_type, operation_params, semantic_match)
            result = {
                **semantic_match,
                "match_method": "semantic",
                "validation_time_ms": int((time.time() - start_time) * 1000)
            }
            self._record_interception(operation_type, operation_params, result, user_id, project_id)
            return result
        
        # æ­¥éª¤4: æœªå‘½ä¸­ä»»ä½•é”™è¯¯ï¼Œæ”¾è¡Œæ“ä½œ
        elapsed = int((time.time() - start_time) * 1000)
        logger.info(f"æ“ä½œå®‰å…¨ï¼Œæ”¾è¡Œ (è€—æ—¶: {elapsed}ms)")
        return {
            "is_safe": True,
            "is_blocked": False,
            "error_id": None,
            "solution": None,
            "avoid_rule": None,
            "match_method": "none",
            "match_score": 0.0,
            "validation_time_ms": elapsed
        }
    
    def record_new_error(
        self,
        error_scene: str,
        error_type: str,
        error_features: Dict,
        error_description: str,
        solution: str,
        avoid_rule: str,
        error_log: Optional[str] = None,
        validation_tool: Optional[str] = None,
        tags: Optional[List[str]] = None
    ) -> str:
        """
        è®°å½•æ–°é”™è¯¯åˆ°çŸ¥è¯†åº“
        
        Args:
            error_scene: é”™è¯¯åœºæ™¯ (ios_build, api_call, ...)
            error_type: é”™è¯¯ç±»å‹ (environment, syntax, ...)
            error_features: é”™è¯¯ç‰¹å¾ (device_name, os_version, ...)
            error_description: é”™è¯¯æè¿°
            solution: è§£å†³æ–¹æ¡ˆ
            avoid_rule: è§„é¿è§„åˆ™
            error_log: é”™è¯¯æ—¥å¿—æ ·æœ¬
            validation_tool: ç¯å¢ƒæ ¡éªŒå·¥å…·
            tags: æ ‡ç­¾åˆ—è¡¨
            
        Returns:
            error_id: ç”Ÿæˆçš„é”™è¯¯ID
        """
        # ç”Ÿæˆé”™è¯¯ID
        error_id = self._generate_error_id(error_scene, error_type, error_features)
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        existing = self.db.query(ErrorKnowledge).filter_by(error_id=error_id).first()
        if existing:
            logger.warning(f"é”™è¯¯å·²å­˜åœ¨: {error_id}")
            return error_id
        
        # åˆ›å»ºé”™è¯¯è®°å½•
        error_knowledge = ErrorKnowledge(
            error_id=error_id,
            error_scene=error_scene,
            error_type=error_type,
            error_features=error_features,
            error_description=error_description,
            solution=solution,
            avoid_rule=avoid_rule,
            error_log_sample=error_log,
            validation_tool=validation_tool,
            tags=tags or []
        )
        
        self.db.add(error_knowledge)
        self.db.commit()
        
        # ç”Ÿæˆå‘é‡å¹¶å­˜å‚¨åˆ°Milvus
        embedding = self.embedding_service.get_embedding(error_description)
        self.vector_db.insert_vectors(
            collection_name="error_vectors",
            data=[{
                "error_id": error_id,
                "embedding": embedding,
                "error_scene": error_scene,
                "error_type": error_type,
                "created_at": int(time.time())
            }]
        )
        
        logger.info(f"æ–°é”™è¯¯å·²è®°å½•: {error_id}")
        return error_id
    
    # ==================== ç§æœ‰æ–¹æ³• ====================
    
    def _check_cache(self, operation_type: str, operation_params: Dict) -> Optional[Dict]:
        """ä»Redisç¼“å­˜æ£€æŸ¥é”™è¯¯"""
        cache_key = self._generate_cache_key(operation_type, operation_params)
        cached_data = self.redis_client.cache_get(cache_key)
        
        if cached_data:
            return {
                "is_safe": False,
                "is_blocked": True,
                "error_id": cached_data.get("error_id"),
                "solution": cached_data.get("solution"),
                "avoid_rule": cached_data.get("avoid_rule"),
                "match_score": 1.0
            }
        return None
    
    def _exact_match(self, operation_type: str, operation_params: Dict) -> Optional[Dict]:
        """ç²¾å‡†åŒ¹é…é”™è¯¯ (åŸºäºerror_featureså®Œå…¨åŒ¹é…)"""
        # æŸ¥è¯¢åŒ¹é…çš„é”™è¯¯
        errors = self.db.query(ErrorKnowledge).filter(
            ErrorKnowledge.error_scene == operation_type,
            ErrorKnowledge.is_active == True
        ).all()
        
        for error in errors:
            # æ£€æŸ¥error_featuresæ˜¯å¦å®Œå…¨åŒ¹é…
            if self._features_match(error.error_features, operation_params):
                # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                error.hit_count += 1
                error.last_hit_at = func.now()
                self.db.commit()
                
                return {
                    "is_safe": False,
                    "is_blocked": True,
                    "error_id": error.error_id,
                    "solution": error.solution,
                    "avoid_rule": error.avoid_rule,
                    "match_score": 1.0
                }
        
        return None
    
    def _semantic_match(self, operation_type: str, operation_params: Dict) -> Optional[Dict]:
        """è¯­ä¹‰åŒ¹é…é”™è¯¯ (åŸºäºå‘é‡ç›¸ä¼¼åº¦)"""
        # æ„é€ æŸ¥è¯¢æ–‡æœ¬
        query_text = self._build_query_text(operation_type, operation_params)
        
        # è½¬æ¢ä¸ºå‘é‡
        query_embedding = self.embedding_service.get_embedding(query_text)
        
        # å‘é‡æ£€ç´¢
        filter_expr = f'error_scene == "{operation_type}"'
        results = self.vector_db.search_vectors(
            collection_name="error_vectors",
            query_vectors=[query_embedding],
            top_k=1,
            filter_expr=filter_expr
        )
        
        if results and len(results[0]) > 0:
            top_result = results[0][0]
            similarity_score = 1 - top_result["distance"]  # COSINEè·ç¦»è½¬ç›¸ä¼¼åº¦
            
            # è·å–é˜ˆå€¼
            error_id = top_result["id"]
            error = self.db.query(ErrorKnowledge).filter_by(error_id=error_id).first()
            
            if error and similarity_score >= error.match_threshold:
                # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                error.hit_count += 1
                error.last_hit_at = func.now()
                self.db.commit()
                
                return {
                    "is_safe": False,
                    "is_blocked": True,
                    "error_id": error.error_id,
                    "solution": error.solution,
                    "avoid_rule": error.avoid_rule,
                    "match_score": similarity_score
                }
        
        return None
    
    def _features_match(self, error_features: Dict, operation_params: Dict) -> bool:
        """æ£€æŸ¥ç‰¹å¾æ˜¯å¦åŒ¹é…"""
        for key, value in error_features.items():
            if key not in operation_params:
                return False
            # æ ‡å‡†åŒ–æ¯”è¾ƒ (ç»Ÿä¸€å°å†™ã€å»é™¤ç©ºæ ¼)
            param_value = str(operation_params[key]).lower().replace(" ", "")
            feature_value = str(value).lower().replace(" ", "")
            if param_value != feature_value:
                return False
        return True
    
    def _build_query_text(self, operation_type: str, operation_params: Dict) -> str:
        """æ„é€ æŸ¥è¯¢æ–‡æœ¬"""
        params_str = " ".join([f"{k}={v}" for k, v in operation_params.items()])
        return f"{operation_type} {params_str}"
    
    def _generate_error_id(self, error_scene: str, error_type: str, error_features: Dict) -> str:
        """ç”Ÿæˆé”™è¯¯ID"""
        key_params = "_".join([str(v).replace(" ", "").lower() for v in list(error_features.values())[:2]])
        return f"{error_scene}_{error_type}_{key_params}"
    
    def _generate_cache_key(self, operation_type: str, operation_params: Dict) -> str:
        """ç”Ÿæˆç¼“å­˜é”®"""
        params_hash = hash(frozenset(operation_params.items()))
        return f"{self.CACHE_PREFIX}{operation_type}:{params_hash}"
    
    def _update_cache(self, operation_type: str, operation_params: Dict, error_data: Dict):
        """æ›´æ–°ç¼“å­˜"""
        cache_key = self._generate_cache_key(operation_type, operation_params)
        cache_value = {
            "error_id": error_data["error_id"],
            "solution": error_data["solution"],
            "avoid_rule": error_data["avoid_rule"]
        }
        self.redis_client.cache_set(cache_key, cache_value, ttl=self.CACHE_TTL)
    
    def _record_interception(
        self,
        operation_type: str,
        operation_params: Dict,
        result: Dict,
        user_id: Optional[str],
        project_id: Optional[str]
    ):
        """è®°å½•æ‹¦æˆªå†å²"""
        interception = ErrorInterception(
            interception_id=generate_id("int"),
            error_id=result.get("error_id"),
            user_id=user_id,
            project_id=project_id,
            operation_type=operation_type,
            operation_params=operation_params,
            match_method=result["match_method"],
            match_score=result.get("match_score"),
            match_time_ms=result["validation_time_ms"],
            is_blocked=result["is_blocked"],
            block_reason=f"åŒ¹é…å†å²é”™è¯¯: {result.get('error_id')}" if result["is_blocked"] else None,
            solution_provided=result.get("solution")
        )
        
        self.db.add(interception)
        self.db.commit()
```

#### 4.2.2 ç¯å¢ƒæ ¡éªŒå·¥å…· (Validation Tools)

**ä½ç½®**: `src/mcp_core/validation_tools/`

##### iOSæ¨¡æ‹Ÿå™¨æŸ¥è¯¢å·¥å…·

**æ–‡ä»¶**: `src/mcp_core/validation_tools/ios_simulator_tool.py`

```python
"""
iOSè™šæ‹Ÿè®¾å¤‡æŸ¥è¯¢å·¥å…·
æŸ¥è¯¢å½“å‰Xcodeä¸­å¯ç”¨çš„è™šæ‹Ÿè®¾å¤‡åˆ—è¡¨
"""

import subprocess
import json
from typing import Dict, List
from ..common.logger import get_context_logger

logger = get_context_logger(__name__)


class iOSSimulatorTool:
    """iOSæ¨¡æ‹Ÿå™¨æŸ¥è¯¢å·¥å…·"""
    
    @staticmethod
    def list_available_devices() -> List[Dict]:
        """
        è·å–æ‰€æœ‰å¯ç”¨çš„iOSè™šæ‹Ÿè®¾å¤‡
        
        Returns:
            [
                {
                    "device_name": "iPhone 15 Pro",
                    "os_version": "17.2",
                    "device_id": "xxxxx-xxxx-xxxx",
                    "is_available": true,
                    "state": "Booted"
                },
                ...
            ]
        """
        try:
            # æ‰§è¡Œå‘½ä»¤
            result = subprocess.run(
                ["xcrun", "simctl", "list", "devices", "available", "--json"],
                capture_output=True,
                text=True,
                timeout=10
            )
            
            if result.returncode != 0:
                logger.error(f"è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥: {result.stderr}")
                return []
            
            # è§£æJSON
            data = json.loads(result.stdout)
            devices = []
            
            for runtime, device_list in data.get("devices", {}).items():
                # æå–iOSç‰ˆæœ¬ (å¦‚ "com.apple.CoreSimulator.SimRuntime.iOS-17-2" -> "17.2")
                os_version = runtime.split("iOS-")[-1].replace("-", ".") if "iOS" in runtime else "unknown"
                
                for device in device_list:
                    if device.get("isAvailable", False):
                        devices.append({
                            "device_name": device["name"],
                            "os_version": os_version,
                            "device_id": device["udid"],
                            "is_available": True,
                            "state": device.get("state", "Unknown")
                        })
            
            logger.info(f"æ‰¾åˆ° {len(devices)} ä¸ªå¯ç”¨iOSè™šæ‹Ÿè®¾å¤‡")
            return devices
            
        except subprocess.TimeoutExpired:
            logger.error("è·å–è®¾å¤‡åˆ—è¡¨è¶…æ—¶")
            return []
        except json.JSONDecodeError as e:
            logger.error(f"è§£æè®¾å¤‡åˆ—è¡¨JSONå¤±è´¥: {e}")
            return []
        except Exception as e:
            logger.error(f"è·å–è®¾å¤‡åˆ—è¡¨å¼‚å¸¸: {e}")
            return []
    
    @staticmethod
    def validate_device(device_name: str, os_version: str) -> Dict:
        """
        éªŒè¯æŒ‡å®šè®¾å¤‡æ˜¯å¦å­˜åœ¨
        
        Args:
            device_name: è®¾å¤‡åç§° (å¦‚ "iPhone 15")
            os_version: ç³»ç»Ÿç‰ˆæœ¬ (å¦‚ "17.0")
            
        Returns:
            {
                "exists": bool,
                "exact_match": Dict or None,  # å®Œå…¨åŒ¹é…çš„è®¾å¤‡
                "similar_devices": List[Dict] # ç›¸ä¼¼è®¾å¤‡æ¨è
            }
        """
        available_devices = iOSSimulatorTool.list_available_devices()
        
        # æ ‡å‡†åŒ–è¾“å…¥
        device_name_normalized = device_name.lower().replace(" ", "")
        os_version_normalized = os_version.replace(".", "")
        
        exact_match = None
        similar_devices = []
        
        for device in available_devices:
            device_name_check = device["device_name"].lower().replace(" ", "")
            os_version_check = device["os_version"].replace(".", "")
            
            # å®Œå…¨åŒ¹é…
            if device_name_check == device_name_normalized and os_version_check == os_version_normalized:
                exact_match = device
                break
            
            # ç›¸ä¼¼è®¾å¤‡ (è®¾å¤‡åç›¸åŒä½†ç‰ˆæœ¬ä¸åŒï¼Œæˆ–è®¾å¤‡åç›¸ä¼¼)
            if device_name_normalized in device_name_check or device_name_check in device_name_normalized:
                similar_devices.append(device)
        
        return {
            "exists": exact_match is not None,
            "exact_match": exact_match,
            "similar_devices": similar_devices[:5]  # æœ€å¤šè¿”å›5ä¸ªæ¨è
        }
```

##### é€šç”¨ç¯å¢ƒæ ¡éªŒå·¥å…·æ¥å£

**æ–‡ä»¶**: `src/mcp_core/validation_tools/base_validator.py`

```python
"""
é€šç”¨ç¯å¢ƒæ ¡éªŒå·¥å…·åŸºç±»
æ‰€æœ‰æ ¡éªŒå·¥å…·ç»§æ‰¿æ­¤åŸºç±»
"""

from abc import ABC, abstractmethod
from typing import Dict, Any


class BaseValidator(ABC):
    """ç¯å¢ƒæ ¡éªŒå·¥å…·åŸºç±»"""
    
    @abstractmethod
    def validate(self, params: Dict[str, Any]) -> Dict:
        """
        éªŒè¯æ“ä½œå‚æ•°
        
        Args:
            params: æ“ä½œå‚æ•°
            
        Returns:
            {
                "is_valid": bool,
                "error_message": str or None,
                "suggestions": List[str]
            }
        """
        pass
    
    @abstractmethod
    def get_validator_name(self) -> str:
        """è¿”å›æ ¡éªŒå™¨åç§°"""
        pass
```

#### 4.2.3 MCPå·¥å…·é›†æˆ

**ä½ç½®**: `src/mcp_core/tools/error_firewall_tools.py`

```python
"""
é”™è¯¯é˜²ç«å¢™MCPå·¥å…·
æ³¨å†Œåˆ°MCPæœåŠ¡å™¨ï¼Œä¾›AIè°ƒç”¨
"""

from typing import Any, Dict
from ..services.error_firewall_service import ErrorFirewallService
from ..validation_tools.ios_simulator_tool import iOSSimulatorTool
from ..models.database import get_db_session
from ..common.logger import get_context_logger

logger = get_context_logger(__name__)


# ==================== MCPå·¥å…·å®šä¹‰ ====================

async def validate_ios_build(
    device_name: str,
    os_version: str,
    project_id: str = None
) -> Dict[str, Any]:
    """
    éªŒè¯iOSç¼–è¯‘æ“ä½œæ˜¯å¦å®‰å…¨
    
    Args:
        device_name: ç›®æ ‡è®¾å¤‡åç§° (å¦‚ "iPhone 15")
        os_version: ç›®æ ‡ç³»ç»Ÿç‰ˆæœ¬ (å¦‚ "17.0")
        project_id: é¡¹ç›®ID
        
    Returns:
        {
            "is_safe": bool,
            "is_blocked": bool,
            "error_id": str,
            "solution": str,
            "available_devices": List[Dict]
        }
    """
    with get_db_session() as db:
        firewall_service = ErrorFirewallService(db)
        
        # éªŒè¯æ“ä½œ
        result = firewall_service.validate_operation(
            operation_type="ios_build",
            operation_params={
                "device_name": device_name,
                "os_version": os_version
            },
            project_id=project_id
        )
        
        # å¦‚æœè¢«æ‹¦æˆªï¼Œè¿”å›æ‹¦æˆªä¿¡æ¯
        if result["is_blocked"]:
            logger.warning(f"iOSç¼–è¯‘æ“ä½œè¢«æ‹¦æˆª: {device_name} {os_version}")
            return {
                "is_safe": False,
                "is_blocked": True,
                "error_id": result["error_id"],
                "solution": result["solution"],
                "avoid_rule": result["avoid_rule"],
                "available_devices": []
            }
        
        # å¦‚æœæœªæ‹¦æˆªï¼Œè¿›è¡Œç¯å¢ƒæ ¡éªŒ
        validation_result = iOSSimulatorTool.validate_device(device_name, os_version)
        
        if not validation_result["exists"]:
            # è®¾å¤‡ä¸å­˜åœ¨ï¼Œè®°å½•æ–°é”™è¯¯
            error_id = firewall_service.record_new_error(
                error_scene="ios_build",
                error_type="environment",
                error_features={
                    "device_name": device_name,
                    "os_version": os_version
                },
                error_description=f"iOSé¡¹ç›®ç¼–è¯‘æ—¶é€‰æ‹©äº†ä¸å­˜åœ¨çš„è™šæ‹Ÿè®¾å¤‡ {device_name} (iOS {os_version})",
                solution=f"ä»ä»¥ä¸‹å¯ç”¨è®¾å¤‡ä¸­é€‰æ‹©ï¼š\n" + "\n".join([
                    f"- {d['device_name']} (iOS {d['os_version']})"
                    for d in validation_result["similar_devices"]
                ]),
                avoid_rule=f"ç¼–è¯‘iOSé¡¹ç›®å‰ï¼Œå¿…é¡»å…ˆè°ƒç”¨ validate_ios_build å·¥å…·éªŒè¯è®¾å¤‡å­˜åœ¨æ€§",
                validation_tool="ios_simulator_query",
                tags=["ios", "xcode", "simulator"]
            )
            
            logger.info(f"è®°å½•æ–°é”™è¯¯: {error_id}")
            
            return {
                "is_safe": False,
                "is_blocked": True,
                "error_id": error_id,
                "solution": f"è®¾å¤‡ {device_name} (iOS {os_version}) ä¸å­˜åœ¨",
                "available_devices": validation_result["similar_devices"]
            }
        
        # è®¾å¤‡å­˜åœ¨ï¼Œæ”¾è¡Œ
        return {
            "is_safe": True,
            "is_blocked": False,
            "error_id": None,
            "solution": None,
            "available_devices": [validation_result["exact_match"]]
        }


async def query_ios_simulators() -> Dict[str, Any]:
    """
    æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„iOSè™šæ‹Ÿè®¾å¤‡
    
    Returns:
        {
            "devices": List[Dict],
            "count": int
        }
    """
    devices = iOSSimulatorTool.list_available_devices()
    
    return {
        "devices": devices,
        "count": len(devices)
    }


async def record_error(
    error_scene: str,
    error_type: str,
    error_description: str,
    solution: str,
    error_features: Dict[str, Any],
    avoid_rule: str = None,
    tags: list = None
) -> Dict[str, Any]:
    """
    æ‰‹åŠ¨è®°å½•é”™è¯¯åˆ°çŸ¥è¯†åº“
    
    Args:
        error_scene: é”™è¯¯åœºæ™¯
        error_type: é”™è¯¯ç±»å‹
        error_description: é”™è¯¯æè¿°
        solution: è§£å†³æ–¹æ¡ˆ
        error_features: é”™è¯¯ç‰¹å¾
        avoid_rule: è§„é¿è§„åˆ™
        tags: æ ‡ç­¾
        
    Returns:
        {
            "error_id": str,
            "success": bool
        }
    """
    with get_db_session() as db:
        firewall_service = ErrorFirewallService(db)
        
        error_id = firewall_service.record_new_error(
            error_scene=error_scene,
            error_type=error_type,
            error_features=error_features,
            error_description=error_description,
            solution=solution,
            avoid_rule=avoid_rule or f"æ‰§è¡Œ {error_scene} æ“ä½œå‰ï¼Œè¯·ç¡®ä¿æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š{error_description}",
            tags=tags or []
        )
        
        return {
            "error_id": error_id,
            "success": True
        }


# ==================== MCPå·¥å…·æ³¨å†Œ ====================

ERROR_FIREWALL_TOOLS = [
    {
        "name": "validate_ios_build",
        "description": "éªŒè¯iOSç¼–è¯‘æ“ä½œæ˜¯å¦å®‰å…¨ï¼Œæ£€æŸ¥ç›®æ ‡è™šæ‹Ÿè®¾å¤‡æ˜¯å¦å­˜åœ¨",
        "input_schema": {
            "type": "object",
            "properties": {
                "device_name": {
                    "type": "string",
                    "description": "ç›®æ ‡è®¾å¤‡åç§° (å¦‚ 'iPhone 15')"
                },
                "os_version": {
                    "type": "string",
                    "description": "ç›®æ ‡ç³»ç»Ÿç‰ˆæœ¬ (å¦‚ '17.0')"
                },
                "project_id": {
                    "type": "string",
                    "description": "é¡¹ç›®ID (å¯é€‰)"
                }
            },
            "required": ["device_name", "os_version"]
        },
        "handler": validate_ios_build
    },
    {
        "name": "query_ios_simulators",
        "description": "æŸ¥è¯¢å½“å‰Xcodeä¸­æ‰€æœ‰å¯ç”¨çš„iOSè™šæ‹Ÿè®¾å¤‡",
        "input_schema": {
            "type": "object",
            "properties": {}
        },
        "handler": query_ios_simulators
    },
    {
        "name": "record_error",
        "description": "æ‰‹åŠ¨è®°å½•é”™è¯¯åˆ°çŸ¥è¯†åº“",
        "input_schema": {
            "type": "object",
            "properties": {
                "error_scene": {"type": "string"},
                "error_type": {"type": "string"},
                "error_description": {"type": "string"},
                "solution": {"type": "string"},
                "error_features": {"type": "object"},
                "avoid_rule": {"type": "string"},
                "tags": {"type": "array", "items": {"type": "string"}}
            },
            "required": ["error_scene", "error_type", "error_description", "solution", "error_features"]
        },
        "handler": record_error
    }
]
```

### 4.3 æ‹¦æˆªä¸­é—´ä»¶è®¾è®¡

**ä½ç½®**: `src/mcp_core/middleware/error_firewall_middleware.py`

```python
"""
é”™è¯¯é˜²ç«å¢™ä¸­é—´ä»¶
åœ¨AIæ“ä½œæ‰§è¡Œå‰è‡ªåŠ¨æ‹¦æˆªé«˜é£é™©æ“ä½œ
"""

from typing import Callable, Dict, Any
from functools import wraps
from ..services.error_firewall_service import ErrorFirewallService
from ..models.database import get_db_session
from ..common.logger import get_context_logger

logger = get_context_logger(__name__)


# é«˜é£é™©æ“ä½œç±»å‹ (éœ€è¦å¼ºåˆ¶æ ¡éªŒ)
HIGH_RISK_OPERATIONS = [
    "ios_build",
    "android_build",
    "npm_install",
    "pip_install",
    "api_call",
    "database_migration",
    "file_delete"
]


def error_firewall(operation_type: str):
    """
    é”™è¯¯é˜²ç«å¢™è£…é¥°å™¨
    
    ä½¿ç”¨ç¤ºä¾‹:
        @error_firewall("ios_build")
        async def build_ios_project(device_name: str, os_version: str):
            # å®é™…ç¼–è¯‘é€»è¾‘
            pass
    
    Args:
        operation_type: æ“ä½œç±»å‹
    """
    def decorator(func: Callable):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # æå–æ“ä½œå‚æ•°
            operation_params = kwargs.copy()
            
            # å¦‚æœæ˜¯é«˜é£é™©æ“ä½œï¼Œå¼ºåˆ¶æ ¡éªŒ
            if operation_type in HIGH_RISK_OPERATIONS:
                logger.info(f"é«˜é£é™©æ“ä½œæ£€æµ‹: {operation_type}, å‚æ•°: {operation_params}")
                
                with get_db_session() as db:
                    firewall_service = ErrorFirewallService(db)
                    
                    # éªŒè¯æ“ä½œ
                    result = firewall_service.validate_operation(
                        operation_type=operation_type,
                        operation_params=operation_params
                    )
                    
                    # å¦‚æœè¢«æ‹¦æˆªï¼Œç›´æ¥è¿”å›æ‹¦æˆªç»“æœ
                    if result["is_blocked"]:
                        logger.warning(f"æ“ä½œè¢«æ‹¦æˆª: {operation_type}, é”™è¯¯ID: {result['error_id']}")
                        return {
                            "success": False,
                            "blocked": True,
                            "error_id": result["error_id"],
                            "message": f"æ“ä½œè¢«é”™è¯¯é˜²ç«å¢™æ‹¦æˆª",
                            "solution": result["solution"],
                            "avoid_rule": result["avoid_rule"]
                        }
            
            # æœªè¢«æ‹¦æˆªï¼Œæ‰§è¡ŒåŸå‡½æ•°
            return await func(*args, **kwargs)
        
        return wrapper
    return decorator
```

### 4.4 ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹1: AIè°ƒç”¨é”™è¯¯é˜²ç«å¢™å·¥å…·

```python
# AIç¼–ç¨‹åŠ©æ‰‹å·¥ä½œæµç¨‹

# æ­¥éª¤1: AIå‡†å¤‡ç¼–è¯‘iOSé¡¹ç›®
device_name = "iPhone 15"
os_version = "17.0"

# æ­¥éª¤2: AIè°ƒç”¨MCPå·¥å…·è¿›è¡Œæ ¡éªŒ (å¼ºåˆ¶)
result = await mcp_client.call_tool(
    "validate_ios_build",
    {
        "device_name": device_name,
        "os_version": os_version,
        "project_id": "my_ios_app"
    }
)

# æ­¥éª¤3: æ ¹æ®æ ¡éªŒç»“æœå†³å®šåç»­æ“ä½œ
if result["is_blocked"]:
    # è¢«æ‹¦æˆªï¼Œæ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ
    print(f"âŒ æ“ä½œè¢«æ‹¦æˆª")
    print(f"é”™è¯¯ID: {result['error_id']}")
    print(f"è§£å†³æ–¹æ¡ˆ:\n{result['solution']}")
    
    # AIæ ¹æ®è§£å†³æ–¹æ¡ˆä¿®æ­£æ“ä½œ
    if result["available_devices"]:
        # ä½¿ç”¨æ¨èçš„è®¾å¤‡
        device_name = result["available_devices"][0]["device_name"]
        os_version = result["available_devices"][0]["os_version"]
        print(f"âœ… ä¿®æ­£ä¸º: {device_name} (iOS {os_version})")
else:
    # æœªæ‹¦æˆªï¼Œç»§ç»­ç¼–è¯‘
    print(f"âœ… è®¾å¤‡éªŒè¯é€šè¿‡ï¼Œå¼€å§‹ç¼–è¯‘...")
    # æ‰§è¡Œå®é™…ç¼–è¯‘æ“ä½œ
```

#### ç¤ºä¾‹2: ä½¿ç”¨æ‹¦æˆªä¸­é—´ä»¶

```python
from src.mcp_core.middleware.error_firewall_middleware import error_firewall

@error_firewall("ios_build")
async def build_ios_project(device_name: str, os_version: str, scheme: str):
    """
    ç¼–è¯‘iOSé¡¹ç›®
    æ­¤å‡½æ•°ä¼šè‡ªåŠ¨è¢«é”™è¯¯é˜²ç«å¢™æ‹¦æˆªæ ¡éªŒ
    """
    # å®é™…ç¼–è¯‘é€»è¾‘
    result = subprocess.run([
        "xcodebuild",
        "-scheme", scheme,
        "-destination", f"platform=iOS Simulator,name={device_name},OS={os_version}",
        "build"
    ])
    
    return {"success": result.returncode == 0}

# è°ƒç”¨æ—¶ä¼šè‡ªåŠ¨è§¦å‘æ ¡éªŒ
result = await build_ios_project(
    device_name="iPhone 15",
    os_version="17.0",
    scheme="MyApp"
)
```

---

## å®ç°è·¯çº¿å›¾

### 5.1 Phase 1: åŸºç¡€è®¾æ–½æ­å»º (1å‘¨)

**ç›®æ ‡**: å»ºç«‹é”™è¯¯çŸ¥è¯†åº“ + æ ¸å¿ƒæœåŠ¡

#### ä»»åŠ¡æ¸…å•

- [ ] **æ•°æ®åº“Schema**
  - [ ] åˆ›å»º `error_knowledge` è¡¨
  - [ ] åˆ›å»º `error_interceptions` è¡¨
  - [ ] åˆ›å»ºæ•°æ®åº“ç´¢å¼•
  - [ ] ç¼–å†™è¿ç§»è„šæœ¬

- [ ] **å‘é‡Collection**
  - [ ] åœ¨Milvusä¸­åˆ›å»º `error_vectors` Collection
  - [ ] é…ç½®HNSWç´¢å¼•

- [ ] **æ ¸å¿ƒæœåŠ¡**
  - [ ] å®ç° `ErrorFirewallService`
  - [ ] å®ç°é”™è¯¯åŒ¹é…é€»è¾‘ (ç¼“å­˜ + ç²¾å‡† + è¯­ä¹‰)
  - [ ] å®ç°é”™è¯¯è®°å½•é€»è¾‘

- [ ] **å•å…ƒæµ‹è¯•**
  - [ ] `test_error_firewall_service.py` (>85%è¦†ç›–ç‡)
  - [ ] Mockæ•°æ®åº“ã€Redisã€Milvus

**é¢„æœŸæˆæœ**:
- å®Œæ•´çš„é”™è¯¯çŸ¥è¯†åº“æ¶æ„
- æ ¸å¿ƒæœåŠ¡é€šè¿‡å•å…ƒæµ‹è¯•
- æ–‡æ¡£: `ERROR_FIREWALL_SERVICE_DESIGN.md`

### 5.2 Phase 2: iOSåœºæ™¯å®ç° (3å¤©)

**ç›®æ ‡**: å®Œæ•´å®ç°iOSè™šæ‹Ÿè®¾å¤‡é”™è¯¯é˜²æŠ¤

#### ä»»åŠ¡æ¸…å•

- [ ] **iOSæ ¡éªŒå·¥å…·**
  - [ ] å®ç° `iOSSimulatorTool`
  - [ ] å®ç°è®¾å¤‡åˆ—è¡¨æŸ¥è¯¢
  - [ ] å®ç°è®¾å¤‡å­˜åœ¨æ€§éªŒè¯

- [ ] **MCPå·¥å…·**
  - [ ] æ³¨å†Œ `validate_ios_build` å·¥å…·
  - [ ] æ³¨å†Œ `query_ios_simulators` å·¥å…·
  - [ ] æ³¨å†Œ `record_error` å·¥å…·

- [ ] **æ‹¦æˆªä¸­é—´ä»¶**
  - [ ] å®ç° `@error_firewall` è£…é¥°å™¨
  - [ ] é›†æˆåˆ°iOSç¼–è¯‘æµç¨‹

- [ ] **åˆå§‹é”™è¯¯çŸ¥è¯†**
  - [ ] å½•å…¥10ä¸ªå¸¸è§iOSç¼–è¯‘é”™è¯¯
  - [ ] ç”Ÿæˆé”™è¯¯å‘é‡

- [ ] **é›†æˆæµ‹è¯•**
  - [ ] ç«¯åˆ°ç«¯æµ‹è¯•iOSåœºæ™¯
  - [ ] éªŒè¯æ‹¦æˆªæˆåŠŸç‡ >95%

**é¢„æœŸæˆæœ**:
- iOSåœºæ™¯å®Œæ•´å¯ç”¨
- åˆå§‹é”™è¯¯çŸ¥è¯†åº“ (10æ¡)
- æ–‡æ¡£: `IOS_ERROR_FIREWALL_GUIDE.md`

### 5.3 Phase 3: æ‰©å±•æ›´å¤šåœºæ™¯ (2å‘¨)

**ç›®æ ‡**: æ”¯æŒæ›´å¤šç¼–ç¨‹åœºæ™¯

#### åœºæ™¯åˆ—è¡¨

1. **Androidç¼–è¯‘é”™è¯¯**
   - ä¸å­˜åœ¨çš„è™šæ‹Ÿè®¾å¤‡
   - Gradleç‰ˆæœ¬ä¸å…¼å®¹

2. **ä¾èµ–å®‰è£…é”™è¯¯**
   - npmåŒ…ç‰ˆæœ¬å†²çª
   - pipä¾èµ–ç¼ºå¤±

3. **APIè°ƒç”¨é”™è¯¯**
   - å·²åºŸå¼ƒçš„API
   - æƒé™ä¸è¶³

4. **æ•°æ®åº“è¿ç§»é”™è¯¯**
   - Schemaä¸å…¼å®¹
   - å¤–é”®çº¦æŸå†²çª

**é¢„æœŸæˆæœ**:
- æ”¯æŒ5ç§ä»¥ä¸Šåœºæ™¯
- é”™è¯¯çŸ¥è¯†åº“ >50æ¡
- æ‹¦æˆªæˆåŠŸç‡ >90%

### 5.4 Phase 4: æ™ºèƒ½åŒ–å¢å¼º (1å‘¨)

**ç›®æ ‡**: æå‡ç³»ç»Ÿæ™ºèƒ½åº¦

#### å¢å¼ºåŠŸèƒ½

- [ ] **è‡ªåŠ¨è§£å†³æ–¹æ¡ˆæ‰§è¡Œ**
  - [ ] æ”¯æŒè‡ªåŠ¨æ‰§è¡Œè§£å†³æ–¹æ¡ˆå‘½ä»¤
  - [ ] ç”¨æˆ·ç¡®è®¤æœºåˆ¶

- [ ] **é”™è¯¯è¶‹åŠ¿åˆ†æ**
  - [ ] ç»Ÿè®¡é”™è¯¯æ‹¦æˆªè¶‹åŠ¿
  - [ ] ç”Ÿæˆé”™è¯¯æŠ¥å‘Š

- [ ] **çŸ¥è¯†åº“ä¼˜åŒ–**
  - [ ] è‡ªåŠ¨æ¸…ç†å¤±æ•ˆé”™è¯¯
  - [ ] é”™è¯¯åˆå¹¶ï¼ˆç›¸ä¼¼é”™è¯¯å»é‡ï¼‰

- [ ] **ç”¨æˆ·åé¦ˆé—­ç¯**
  - [ ] æ”¶é›†ç”¨æˆ·å¯¹è§£å†³æ–¹æ¡ˆçš„åé¦ˆ
  - [ ] æ ¹æ®åé¦ˆè°ƒæ•´åŒ¹é…é˜ˆå€¼

**é¢„æœŸæˆæœ**:
- è‡ªåŠ¨åŒ–ç‡ >50%
- ç”¨æˆ·æ»¡æ„åº¦ >85%

---

## åº”ç”¨åœºæ™¯

### 6.1 iOS/Androidç§»åŠ¨å¼€å‘

| é”™è¯¯ç±»å‹ | ä¼ ç»Ÿæ–¹å¼ | é”™è¯¯é˜²ç«å¢™æ–¹å¼ |
|---------|---------|---------------|
| é€‰æ‹©ä¸å­˜åœ¨çš„è™šæ‹Ÿè®¾å¤‡ | ç¼–è¯‘å¤±è´¥ â†’ æ‰‹åŠ¨æ£€æŸ¥ â†’ ä¿®æ­£ (5-10åˆ†é’Ÿ) | è‡ªåŠ¨æ‹¦æˆª â†’ æ¨èå¯ç”¨è®¾å¤‡ (<10ç§’) |
| ä½¿ç”¨åºŸå¼ƒçš„API | ç¼–è¯‘è­¦å‘Š â†’ æŸ¥æ–‡æ¡£ â†’ ä¿®æ”¹ä»£ç  (10-30åˆ†é’Ÿ) | æ‹¦æˆª â†’ è¿”å›æ–°APIæ›¿ä»£æ–¹æ¡ˆ (<10ç§’) |
| Xcodeé…ç½®é”™è¯¯ | åå¤å°è¯• â†’ æœç´¢è§£å†³æ–¹æ¡ˆ (30åˆ†é’Ÿ+) | å‘½ä¸­çŸ¥è¯†åº“ â†’ ç›´æ¥è¿”å›é…ç½®æ­¥éª¤ (<10ç§’) |

### 6.2 Webå¼€å‘

| é”™è¯¯ç±»å‹ | é”™è¯¯é˜²ç«å¢™åº”ç”¨ |
|---------|---------------|
| å¼•ç”¨å·²åˆ é™¤çš„ç»„ä»¶ | æ‹¦æˆª â†’ æç¤ºç»„ä»¶å·²åˆ é™¤ â†’ æ¨èæ›¿ä»£ç»„ä»¶ |
| npmåŒ…ç‰ˆæœ¬å†²çª | æ‹¦æˆª â†’ è¿”å›å…¼å®¹ç‰ˆæœ¬ç»„åˆ |
| APIæ¥å£å˜æ›´ | æ‹¦æˆª â†’ è¿”å›æ–°æ¥å£æ–‡æ¡£é“¾æ¥ |

### 6.3 æ•°æ®åº“æ“ä½œ

| é”™è¯¯ç±»å‹ | é”™è¯¯é˜²ç«å¢™åº”ç”¨ |
|---------|---------------|
| å¤–é”®çº¦æŸå†²çª | æ‹¦æˆª â†’ æç¤ºä¾èµ–æ•°æ®å¤„ç†é¡ºåº |
| Schemaè¿ç§»å¤±è´¥ | æ‹¦æˆª â†’ è¿”å›å…¼å®¹çš„è¿ç§»è„šæœ¬ |
| ç´¢å¼•åˆ›å»ºå¤±è´¥ | æ‹¦æˆª â†’ æç¤ºè¡¨é”é—®é¢˜ â†’ æ¨èæœ€ä½³æ—¶æœº |

---

## æ€§èƒ½æŒ‡æ ‡

### 7.1 æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹å¼ |
|------|--------|---------|
| ç¼“å­˜å‘½ä¸­å“åº”æ—¶é—´ | <5ms | RedisæŸ¥è¯¢è€—æ—¶ |
| ç²¾å‡†åŒ¹é…å“åº”æ—¶é—´ | <50ms | MySQLæŸ¥è¯¢ + ç‰¹å¾åŒ¹é… |
| è¯­ä¹‰åŒ¹é…å“åº”æ—¶é—´ | <200ms | å‘é‡åŒ– + Milvusæ£€ç´¢ |
| æ€»ä½“P95å“åº”æ—¶é—´ | <300ms | å…¨é“¾è·¯è€—æ—¶ |
| æ‹¦æˆªå‡†ç¡®ç‡ | >95% | æ­£ç¡®æ‹¦æˆªæ•° / æ€»æ‹¦æˆªæ•° |
| è¯¯æ‹¦æˆªç‡ | <1% | è¯¯æ‹¦æˆªæ•° / æ€»æ“ä½œæ•° |
| çŸ¥è¯†åº“è¦†ç›–ç‡ | >80% | å‘½ä¸­æ•° / æ€»é”™è¯¯æ•° |

### 7.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 7.2.1 ç¼“å­˜ä¼˜åŒ–

```python
# å¤šçº§ç¼“å­˜ç­–ç•¥
1. L1ç¼“å­˜ (Redis): 5åˆ†é’Ÿå†…é«˜é¢‘é”™è¯¯ â†’ <5ms
2. L2ç¼“å­˜ (æœ¬åœ°å†…å­˜): è¿›ç¨‹å†…LRUç¼“å­˜ â†’ <1ms
3. L3å­˜å‚¨ (MySQL + Milvus): æŒä¹…åŒ–å­˜å‚¨ â†’ <200ms
```

#### 7.2.2 æ£€ç´¢ä¼˜åŒ–

```python
# æ¸è¿›å¼åŒ¹é…ç­–ç•¥
1. å…ˆæŸ¥L1ç¼“å­˜ (Redis) â†’ å‘½ä¸­åˆ™ç›´æ¥è¿”å›
2. å†æŸ¥L2ç¼“å­˜ (å†…å­˜) â†’ å‘½ä¸­åˆ™æ›´æ–°Redis
3. å†ç²¾å‡†åŒ¹é… (MySQL) â†’ å‘½ä¸­åˆ™æ›´æ–°ç¼“å­˜
4. æœ€åè¯­ä¹‰åŒ¹é… (Milvus) â†’ å‘½ä¸­åˆ™æ›´æ–°ç¼“å­˜
```

#### 7.2.3 å‘é‡æ£€ç´¢ä¼˜åŒ–

```python
# Milvus HNSWå‚æ•°ä¼˜åŒ–
- M: 16 (é‚»å±…æ•°é‡ï¼Œå¹³è¡¡ç²¾åº¦å’Œé€Ÿåº¦)
- efConstruction: 200 (æ„å»ºæ—¶æœç´¢æ·±åº¦)
- efSearch: 64 (æŸ¥è¯¢æ—¶æœç´¢æ·±åº¦)
- é¢„æœŸæ£€ç´¢æ—¶é—´: <100ms (top_k=5)
```

### 7.3 ç›‘æ§æŒ‡æ ‡

#### 7.3.1 å®æ—¶ç›‘æ§

```python
# ç›‘æ§æŒ‡æ ‡
- æ¯åˆ†é’Ÿæ‹¦æˆªæ¬¡æ•°
- å¹³å‡å“åº”æ—¶é—´
- ç¼“å­˜å‘½ä¸­ç‡
- åŒ¹é…æ–¹æ³•åˆ†å¸ƒ (cache/exact/semantic)
- é”™è¯¯åœºæ™¯åˆ†å¸ƒ
```

#### 7.3.2 ç»Ÿè®¡åˆ†æ

```python
# æ¯æ—¥ç»Ÿè®¡
- æ€»æ‹¦æˆªæ¬¡æ•°
- é¿å…çš„é”™è¯¯æ•°
- èŠ‚çœçš„æ—¶é—´ (åŸºäºå¹³å‡ä¿®å¤æ—¶é—´)
- çŸ¥è¯†åº“å¢é•¿æ•°
- ç”¨æˆ·åé¦ˆæ»¡æ„åº¦
```

---

## é™„å½•

### A. é”™è¯¯IDå‘½åè§„èŒƒ

**æ ¼å¼**: `{operation}_{error_type}_{key_param1}_{key_param2}`

**ç¤ºä¾‹**:
- `ios_build_no_device_iphone15_17.0` - iOSç¼–è¯‘ï¼Œè®¾å¤‡ä¸å­˜åœ¨
- `npm_install_version_conflict_react_18` - npmå®‰è£…ï¼Œç‰ˆæœ¬å†²çª
- `api_call_deprecated_getuserinfo_v1` - APIè°ƒç”¨ï¼Œæ¥å£åºŸå¼ƒ

### B. åŒ¹é…ç­–ç•¥è¯´æ˜

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ä¼˜å…ˆçº§ |
|------|---------|--------|
| cache | 5åˆ†é’Ÿå†…é‡å¤æ“ä½œ | 1 (æœ€é«˜) |
| exact | å‚æ•°å®Œå…¨åŒ¹é… | 2 |
| semantic | æè¿°è¯­ä¹‰ç›¸ä¼¼ | 3 |
| hybrid | ç»“æ„åŒ– + è¯­ä¹‰ | 4 |

### C. è§£å†³æ–¹æ¡ˆç±»å‹

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| auto | è‡ªåŠ¨æ‰§è¡Œ | æ‰§è¡Œå‘½ä»¤ä¿®å¤é…ç½® |
| manual | æ‰‹åŠ¨æ“ä½œ | æ­¥éª¤è¯´æ˜ (éœ€ç”¨æˆ·ç¡®è®¤) |
| interactive | äº¤äº’å¼ | æä¾›é€‰é¡¹ä¾›ç”¨æˆ·é€‰æ‹© |

---

**æ–‡æ¡£çŠ¶æ€**: âœ… è®¾è®¡å®Œæˆ  
**ä¸‹ä¸€æ­¥**: å¼€å§‹Phase 1å®ç°  
**é¢„è®¡å®Œæˆæ—¶é—´**: 4å‘¨  
**ç»´æŠ¤è€…**: MCP Enterprise Team

---

**ç‰ˆæƒå£°æ˜**: MIT License  
**åˆ›å»ºæ—¶é—´**: 2025-11-20  
**æœ€åæ›´æ–°**: 2025-11-20

